name: Test Coverage Guardian

on:
  pull_request:
    branches: [main]
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  coverage:
    name: Check Test Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Run tests with coverage
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
          go tool cover -func=coverage.out -o=coverage.txt

      - name: Calculate coverage
        id: coverage
        run: |
          # Calculate total coverage
          TOTAL=$(grep "total:" coverage.txt | awk '{print $3}' | sed 's/%//')
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "Total coverage: $TOTAL%"

          # Calculate internal/ package coverage (exclude cmd/ binaries)
          INTERNAL_COV=$(grep "internal/" coverage.txt | awk '{sum+=$3; count++} END {if(count>0) print sum/count; else print 0}' | sed 's/%//')
          echo "internal=$INTERNAL_COV" >> $GITHUB_OUTPUT
          echo "Internal package coverage: $INTERNAL_COV%"

      - name: Generate coverage report
        run: |
          echo "# Test Coverage Report" > coverage-report.md
          echo "" >> coverage-report.md
          echo "**Total Coverage:** ${{ steps.coverage.outputs.total }}%" >> coverage-report.md
          echo "**Internal Packages Coverage:** ${{ steps.coverage.outputs.internal }}%" >> coverage-report.md
          echo "" >> coverage-report.md
          echo "_Note: Coverage threshold (70%) applies to internal/ packages only. Binaries in cmd/ are excluded as they contain integration code that is difficult to unit test._" >> coverage-report.md
          echo "" >> coverage-report.md
          echo "## Package Coverage" >> coverage-report.md
          echo "" >> coverage-report.md
          echo '```' >> coverage-report.md
          grep -v "total:" coverage.txt | sort -t: -k2 -nr >> coverage-report.md
          echo '```' >> coverage-report.md
          echo "" >> coverage-report.md

          # Coverage thresholds (check internal packages only)
          INTERNAL=${{ steps.coverage.outputs.internal }}
          if (( $(echo "$INTERNAL < 70" | bc -l) )); then
            echo "âš ï¸ **Internal package coverage is below target (70%):** $INTERNAL%" >> coverage-report.md
            echo "" >> coverage-report.md
            echo "Please add tests for internal/ packages before merging." >> coverage-report.md
          elif (( $(echo "$INTERNAL < 80" | bc -l) )); then
            echo "âœ… **Internal package coverage meets minimum target (70%):** $INTERNAL%" >> coverage-report.md
            echo "" >> coverage-report.md
            echo "Consider adding more tests to reach 80% coverage." >> coverage-report.md
          else
            echo "ðŸŽ‰ **Excellent internal package coverage (80%+):** $INTERNAL%" >> coverage-report.md
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('coverage-report.md', 'utf8');

            // Find existing coverage comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Test Coverage Report')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }

      - name: Check coverage threshold
        run: |
          INTERNAL=${{ steps.coverage.outputs.internal }}
          if (( $(echo "$INTERNAL < 70" | bc -l) )); then
            echo "âŒ Internal package coverage $INTERNAL% is below minimum threshold (70%)"
            exit 1
          else
            echo "âœ… Internal package coverage $INTERNAL% meets minimum threshold (70%)"
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
