name: Workflow Health Check

on:
  schedule:
    # Run daily at 10 AM UTC
    - cron: '0 10 * * *'
  workflow_dispatch:  # Allow manual trigger

permissions:
  actions: read
  contents: read

jobs:
  health-check:
    runs-on: ubuntu-latest

    steps:
      - name: Check critical workflows
        uses: actions/github-script@v7
        with:
          script: |
            const workflows = [
              { name: 'telegram-bot.yml', maxHoursSinceRun: 2 },
              { name: 'telegram-bot-commands.yml', maxHoursSinceRun: 7 },
              { name: 'telegram-daily-digest.yml', maxHoursSinceRun: 25 }
            ];

            const now = new Date();
            let allHealthy = true;

            for (const workflow of workflows) {
              console.log(`\nChecking ${workflow.name}...`);

              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflow.name,
                per_page: 5,
                status: 'completed'
              });

              if (runs.data.workflow_runs.length === 0) {
                console.log(`❌ No completed runs found for ${workflow.name}`);
                allHealthy = false;
                continue;
              }

              const lastRun = runs.data.workflow_runs[0];
              const lastRunTime = new Date(lastRun.updated_at);
              const hoursSinceRun = (now - lastRunTime) / (1000 * 60 * 60);

              console.log(`  Last run: ${lastRunTime.toISOString()}`);
              console.log(`  Hours since: ${hoursSinceRun.toFixed(1)}`);
              console.log(`  Status: ${lastRun.conclusion}`);

              if (hoursSinceRun > workflow.maxHoursSinceRun) {
                console.log(`❌ ${workflow.name} hasn't run in ${hoursSinceRun.toFixed(1)} hours (max: ${workflow.maxHoursSinceRun})`);
                allHealthy = false;
              } else if (lastRun.conclusion !== 'success') {
                console.log(`❌ ${workflow.name} last run failed: ${lastRun.conclusion}`);
                allHealthy = false;
              } else {
                console.log(`✅ ${workflow.name} is healthy`);
              }
            }

            if (!allHealthy) {
              core.setFailed('One or more workflows are unhealthy');
            } else {
              console.log('\n✅ All workflows are healthy');
            }
